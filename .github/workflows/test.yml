name: test

on:
  workflow_dispatch:

jobs:
  self-test:
    runs-on: ubuntu-latest
    name: self-test
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read  # This is required for actions/checkout
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: get credentials
        uses: ./ # Uses an action in the root directory
        with:
          role-arn-to-assume: '${{ secrets.ROLE_ARN }}'
          oidc-provider-arn: '${{ secrets.OIDC_ARN }}'

      - name: test aliyun cli
        run: |
          set -e
          wget https://github.com/aliyun/aliyun-cli/releases/download/v3.0.133/aliyun-cli-linux-3.0.133-amd64.tgz --no-verbose
          tar zxvf aliyun-cli-linux-3.0.133-amd64.tgz
          chmod +x ./aliyun
          export ALIBABACLOUD_REGION_ID=ap-southeast-1
          ./aliyun sts GetCallerIdentity | jq .IdentityType
